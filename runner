#!/usr/bin/env bb

(require '[babashka.classpath :as classpath])

(classpath/add-classpath "src")
(require '[curly.run :as curly])
(require '[curly.ext :as ext])

(def hosts
  {:prod "https://httpbin.org"
   :qa  "https://qa.httpbin.org"
   })

(def commands
  {:post-test {:r/host :prod
               :r/method :post
               :r/headers {:Content-Type "application/json"}
               :r/path "/post"
               ; :c/verbose true
               :r/body {:foo "bar"}
               }

   :get-test {:r/host :prod
              :r/path "/get"
              :r/method :get
              }

   :put-test {:r/host :prod
              :r/path "/put"
              :r/headers {:Content-Type "application/json"}
              :r/method :put
              :r/body {:foo "bar"}
              }

   :delete-test {:r/host :prod
                 :r/path "/delete"
                 :r/method :delete
                 }
   })

(defmethod ext/munge-command :post-test
  [_key command]
  (assoc-in command [:r/body :baz] [1 2 3]))

(when (= *file* (System/getProperty "babashka.file"))
  (curly/curl! commands hosts *command-line-args*))
